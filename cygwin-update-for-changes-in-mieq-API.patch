---
 xserver/hw/xwin/InitInput.c |    3 +--
 xserver/hw/xwin/winkeybd.c  |   20 ++++++++++++--------
 xserver/hw/xwin/winmouse.c  |   25 +++++++++++++++----------
 3 files changed, 28 insertions(+), 20 deletions(-)

Index: xorg-server-1.6.0/xserver/hw/xwin/InitInput.c
===================================================================
--- xorg-server-1.6.0.orig/xserver/hw/xwin/InitInput.c	2009-02-26 16:14:40.171875000 +0000
+++ xorg-server-1.6.0/xserver/hw/xwin/InitInput.c	2009-02-26 16:15:10.015625000 +0000
@@ -151,8 +151,7 @@
   g_pwinPointer->name = strdup("Windows mouse");
   g_pwinKeyboard->name = strdup("Windows keyboard");
 
-  miRegisterPointerDevice (screenInfo.screens[0], pMouse);
-  mieqInit ((DevicePtr)pKeyboard, (DevicePtr)pMouse);
+  mieqInit ();
 
   /* Initialize the mode key states */
   winInitializeModeKeyStates ();
Index: xorg-server-1.6.0/xserver/hw/xwin/winkeybd.c
===================================================================
--- xorg-server-1.6.0.orig/xserver/hw/xwin/winkeybd.c	2009-02-26 16:13:13.284625000 +0000
+++ xorg-server-1.6.0/xserver/hw/xwin/winkeybd.c	2009-02-26 16:15:10.015625000 +0000
@@ -580,7 +580,8 @@
 void
 winSendKeyEvent (DWORD dwKey, Bool fDown)
 {
-  xEvent			xCurrentEvent;
+  EventListPtr events;
+  int i, nevents;
 
   /*
    * When alt-tabing between screens we can get phantom key up messages
@@ -590,14 +591,17 @@
 
   /* Update the keyState map */
   g_winKeyState[dwKey] = fDown;
-  
-  ZeroMemory (&xCurrentEvent, sizeof (xCurrentEvent));
 
-  xCurrentEvent.u.u.type = fDown ? KeyPress : KeyRelease;
-  xCurrentEvent.u.keyButtonPointer.time =
-    g_c32LastInputEventTime = GetTickCount ();
-  xCurrentEvent.u.u.detail = dwKey + MIN_KEYCODE;
-  mieqEnqueue (&xCurrentEvent);
+  GetEventList(&events);
+  nevents = GetKeyboardEvents(events, g_pwinKeyboard, fDown ? KeyPress : KeyRelease, dwKey + MIN_KEYCODE);
+
+  for (i = 0; i < nevents; i++)
+    mieqEnqueue(g_pwinKeyboard, events[i].event);
+
+#if CYGDEBUG
+  ErrorF("winSendKeyEvent: dwKey: %d, fDown: %d, nEvents %d\n",
+          dwKey, fDown, nevents);
+#endif
 }
 
 BOOL winCheckKeyPressed(WPARAM wParam, LPARAM lParam)
Index: xorg-server-1.6.0/xserver/hw/xwin/winmouse.c
===================================================================
--- xorg-server-1.6.0.orig/xserver/hw/xwin/winmouse.c	2009-02-26 16:13:13.285625000 +0000
+++ xorg-server-1.6.0/xserver/hw/xwin/winmouse.c	2009-02-26 16:15:10.015625000 +0000
@@ -100,7 +100,6 @@
       InitPointerDeviceStruct (pDevice,
 			       map,
 			       lngMouseButtons + lngWheelEvents,
-			       GetMotionHistory,
 			       winMouseCtrl,
 			       GetMotionHistorySize(),
 			       2);
@@ -221,19 +220,25 @@
 void
 winMouseButtonsSendEvent (int iEventType, int iButton)
 {
-  xEvent		xCurrentEvent;
+  EventListPtr events;
+  int i, nevents;
 
-  /* Load an xEvent and enqueue the event */
-  xCurrentEvent.u.u.type = iEventType;
 #if defined(XFree86Server)
   if (g_winMouseButtonMap)
-    xCurrentEvent.u.u.detail = g_winMouseButtonMap[iButton];
-  else
+    iButton = g_winMouseButtonMap[iButton];
+#endif
+
+  GetEventList(&events);
+  nevents = GetPointerEvents(events, g_pwinPointer, iEventType, iButton,
+			     POINTER_RELATIVE, 0, 0, NULL);
+
+  for (i = 0; i < nevents; i++)
+    mieqEnqueue(g_pwinPointer, events[i].event);
+
+#if CYGDEBUG
+  ErrorF("winMouseButtonsSendEvent: iEventType: %d, iButton: %d, nEvents %d\n",
+          iEventType, iButton, nevents);
 #endif
-  xCurrentEvent.u.u.detail = iButton;
-  xCurrentEvent.u.keyButtonPointer.time
-    = g_c32LastInputEventTime = GetTickCount ();
-  mieqEnqueue (&xCurrentEvent);
 }
 
 
