Fix the long-broken -silent-dup-error option

---
 xserver/hw/xwin/InitOutput.c |   87 -----------------------------------------------------------
 xserver/hw/xwin/XWin.man.pre |    4 +-
 xserver/hw/xwin/winerror.c   |   17 +++++++++++
 3 files changed, 19 insertions(+), 89 deletions(-)

--- origsrc/xorg-server-1.7.0.901/hw/xwin/InitOutput.c	2009-10-13 22:14:32.087315100 -0500
+++ src/xorg-server-1.7.0.901/hw/xwin/InitOutput.c	2009-10-13 22:16:32.659925300 -0500
@@ -117,9 +117,6 @@ OsVendorVErrorF (const char *pszFormat, 
 void
 winInitializeDefaultScreens (void);
 
-static Bool
-winCheckDisplayNumber (void);
-
 void
 winLogCommandLine (int argc, char *argv[]);
 
@@ -944,15 +941,6 @@ InitOutput (ScreenInfo *screenInfo, int 
 		  "Exiting.\n");
     }
 
-  /* Check for duplicate invocation on same display number.*/
-  if (serverGeneration == 1 && !winCheckDisplayNumber ())
-    {
-      if (g_fSilentDupError)
-        g_fSilentFatalError = TRUE;  
-      FatalError ("InitOutput - Duplicate invocation on display "
-		  "number: %s.  Exiting.\n", display);
-    }
-
 #ifdef XWIN_XF86CONFIG
   /* Try to read the xorg.conf-style configuration file */
   if (!winReadConfigfile ())
@@ -1043,78 +1031,3 @@ InitOutput (ScreenInfo *screenInfo, int 
   winDebug ("InitOutput - Returning.\n");
 #endif
 }
-
-
-/*
- * winCheckDisplayNumber - Check if another instance of Cygwin/X is
- * already running on the same display number.  If no one exists,
- * make a mutex to prevent new instances from running on the same display.
- *
- * return FALSE if the display number is already used.
- */
-
-static Bool
-winCheckDisplayNumber (void)
-{
-  int			nDisp;
-  HANDLE		mutex;
-  char			name[MAX_PATH];
-  char *		pszPrefix = '\0';
-  OSVERSIONINFO		osvi = {0};
-
-  /* Check display range */
-  nDisp = atoi (display);
-  if (nDisp < 0 || nDisp > 65535)
-    {
-      ErrorF ("winCheckDisplayNumber - Bad display number: %d\n", nDisp);
-      return FALSE;
-    }
-
-  /* Set first character of mutex name to null */
-  name[0] = '\0';
-
-  /* Get operating system version information */
-  osvi.dwOSVersionInfoSize = sizeof (osvi);
-  GetVersionEx (&osvi);
-
-  /* Want a mutex shared among all terminals on NT > 4.0 */
-  if (osvi.dwPlatformId == VER_PLATFORM_WIN32_NT
-      && osvi.dwMajorVersion >= 5)
-    {
-      pszPrefix = "Global\\";
-    }
-
-  /* Setup Cygwin/X specific part of name */
-  snprintf (name, sizeof(name), "%sCYGWINX_DISPLAY:%d", pszPrefix, nDisp);
-
-  /* Windows automatically releases the mutex when this process exits */
-  mutex = CreateMutex (NULL, FALSE, name);
-  if (!mutex)
-    {
-      LPVOID lpMsgBuf;
-
-      /* Display a fancy error message */
-      FormatMessage (FORMAT_MESSAGE_ALLOCATE_BUFFER | 
-		     FORMAT_MESSAGE_FROM_SYSTEM | 
-		     FORMAT_MESSAGE_IGNORE_INSERTS,
-		     NULL,
-		     GetLastError (),
-		     MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
-		     (LPTSTR) &lpMsgBuf,
-		     0, NULL);
-      ErrorF ("winCheckDisplayNumber - CreateMutex failed: %s\n",
-	      (LPSTR)lpMsgBuf);
-      LocalFree (lpMsgBuf);
-
-      return FALSE;
-    }
-  if (GetLastError () == ERROR_ALREADY_EXISTS)
-    {
-      ErrorF ("winCheckDisplayNumber - "
-	      PROJECT_NAME " is already running on display %d\n",
-	      nDisp);
-      return FALSE;
-    }
-
-  return TRUE;
-}
--- origsrc/xorg-server-1.7.0.901/hw/xwin/XWin.man.pre	2009-08-10 23:00:25.000000000 -0500
+++ src/xorg-server-1.7.0.901/hw/xwin/XWin.man.pre	2009-10-13 22:17:24.717216100 -0500
@@ -231,8 +231,8 @@ The \fIAlt-F4\fP key combination is enab
 Disable the usage of the windows cursor and use the X11 software cursor instead.
 .TP 8
 .B \-silent-dup-error
-If another instance of XWin is found running, exit silently and don't display
-the error message.
+If another instance of XWin with the same display number is found running,
+exit silently and don't display the error message.
 .TP 8
 .B "\-xkblayout \fIlayout\fP"
 .TP 8
--- origsrc/xorg-server-1.7.0.901/hw/xwin/winerror.c	2009-08-10 23:00:25.000000000 -0500
+++ src/xorg-server-1.7.0.901/hw/xwin/winerror.c	2009-10-13 22:19:52.745874200 -0500
@@ -43,6 +43,7 @@
 extern char *		g_pszCommandLine;
 extern char *		g_pszLogFile;
 extern Bool		g_fSilentFatalError;
+extern Bool		g_fSilentDupError;
 
 
 #ifdef DDXOSVERRORF
@@ -62,6 +63,22 @@ OsVendorVErrorF (const char *pszFormat, 
   pthread_mutex_lock (&s_pmPrinting);
 #endif
 
+  /* If we want to silence it,
+   * detect if we are going to abort due to duplication error */
+  if (g_fSilentDupError)
+    {
+      if ((strcmp(pszFormat,
+		  "InitOutput - Duplicate invocation on display "
+		  "number: %s.  Exiting.\n") == 0)
+	  || (strcmp(pszFormat,
+		     "Server is already active for display %s\n%s %s\n%s\n") == 0)
+	  || (strcmp(pszFormat,
+		     "MakeAllCOTSServerListeners: server already running\n") == 0))
+	{
+	  g_fSilentFatalError = TRUE;
+	}
+    }
+
   /* Print the error message to a log file, could be stderr */
   LogVWrite (0, pszFormat, va_args);
 
