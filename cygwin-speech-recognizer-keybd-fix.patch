Cygwin/X: Invent a scan code if we don't have one

Apparently, fake keypresses generated by speech recognizers may not bother
with a scan code, so look up what scan code corresponds to the virtual key
code if this occurs.

Patch by Paul Loewenstein <paul.loewenstein@gmail.com>

--- origsrc/xorg-server-1.5.3/hw/xwin/winkeybd.c	2009-01-17 13:17:33.000000000 -0800
+++ src/xorg-server-1.5.3/hw/xwin/winkeybd.c	2009-01-19 08:21:55.584600000 -0800
@@ -78,10 +78,31 @@
 {
   int		iKeyFixup = g_iKeyMap[wParam * WIN_KEYMAP_COLS + 1];
   int		iKeyFixupEx = g_iKeyMap[wParam * WIN_KEYMAP_COLS + 2];
-  int		iParamScanCode = LOBYTE (HIWORD (lParam));
+  int		iParam = HIWORD (lParam);
+  int		iParamScanCode = LOBYTE (iParam);
 
+/* WM_ key messages faked by Vista speech recognition (WSR) don't have a
+ * scan code.
+ *
+ * Vocola 3 (Rick Mohr's supplement to WSR) uses
+ * System.Windows.Forms.SendKeys.SendWait(), which appears always to give a
+ * scan code of 1
+ */
+  if (iParamScanCode <= 1)
+    {
+      if (VK_PRIOR <= wParam && wParam <= VK_DOWN)
+        /* Trigger special case table to translate to extended
+         * keycode, otherwise if num_lock is on, we can get keypad
+         * numbers instead of navigation keys. */
+        iParam |= KF_EXTENDED;
+      else
+        iParamScanCode = MapVirtualKeyEx(wParam,
+                         /*MAPVK_VK_TO_VSC*/0,
+                         GetKeyboardLayout(0));
+    }
+
   /* Branch on special extended, special non-extended, or normal key */
-  if ((HIWORD (lParam) & KF_EXTENDED) && iKeyFixupEx)
+  if ((iParam & KF_EXTENDED) && iKeyFixupEx)
     *piScanCode = iKeyFixupEx;
   else if (iKeyFixup)
     *piScanCode = iKeyFixup;
--- origsrc/xorg-server-1.5.3/hw/xwin/winkeybd.h	2007-10-23 14:26:52.000000000 -0700
+++ src/xorg-server-1.5.3/hw/xwin/winkeybd.h	2009-01-17 12:46:15.475681500 -0800
@@ -45,6 +45,9 @@
 
 #define		WIN_KEYMAP_COLS		3
 
+/* Rows 160 through 165 correspond to software-generated codes, which
+ * may not be associated with the appropriate scan code.
+ */
 const int
 g_iKeyMap [] = {
   /* count	Windows VK,	ASCII,		ASCII when extended VK */
@@ -208,12 +213,12 @@
   /* 157 */	0,		0,		0,
   /* 158 */	0,		0,		0,
   /* 159 */	0,		0,		0,
-  /* 160 */	0,		0,		0,
-  /* 161 */	0,		0,		0,
-  /* 162 */	0,		0,		0,
-  /* 163 */	0,		0,		0,
-  /* 164 */	0,		0,		0,
-  /* 165 */	0,		0,		0,
+  /* 160 */	VK_LSHIFT,	KEY_ShiftL,	0,
+  /* 161 */	VK_RSHIFT,	KEY_ShiftR,	0,
+  /* 162 */	VK_LCONTROL,	KEY_LCtrl,	0,
+  /* 163 */	VK_RCONTROL,	KEY_RCtrl,	0,
+  /* 164 */	VK_LMENU,	KEY_Alt,	0,
+  /* 165 */	VK_RMENU,	KEY_AltLang,	0,
   /* 166 */	0,		0,		0,
   /* 167 */	0,		0,		0,
   /* 168 */	0,		0,		0,

